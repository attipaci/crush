# ===========================================================================
# CRUSH default configuration for SOFIA/HAWC+
#
# Author: Attila Kovacs <attila@submm.caltech.edu>
# Description:
# 	This configuration file is automatically loaded when crush is started
#       with hawc+ as the instrument. Users may define their own startup
#       configuration in ~/.crush2/hawc+/default.cfg which will be parsed
#       immediately after the global defaults contained here.
# See: crush/README, crush/hawc+/README
# ===========================================================================

# Load SOFIA defaults
config sofia/default.cfg

# ---------------------------------------------------------------------------
# temporary settings:
# ---------------------------------------------------------------------------

# Select specific subarrays only
#subarray T0,R1

# Do not attempt to bootstrap pixel weights. Assume uniform at start...
uniformweights

# Shift data relative to coordinates by the specified amount (seconds).
shift -0.843
#date.[*--2016.05.01] shift -0.87

# Notch out the 42.5 Hz resonance...
#filter.kill
filter.kill.bands 40:45

# Treat gains as signed values, to reject negative values...
array.signed

# Map even if many pixels are flagged
mappingfraction 0.2


# --------------------------------------------------------------------------


# The ordering of models in the default reduction pipeline. 
ordering offsets, drifts, correlated.obs-channels, correlated.nonlinearity, correlated.polarrays, correlated.telescope-x, correlated.chopper-x, correlated.chopper-y, correlated.accel-mag, weighting.frames, filter, weighting, despike, correlated.subarrays, correlated.gradients, correlated.bias, correlated.mux, correlated.rows, source

# If 'calibrated' is set, CRUSH will produce Level 3 data for single scans
# Otherwise, the default is to produce Level 2 data for single scans
#calibrated

# Activate DRP messages over TCP/IP
#drp

# Various options for the DRP messaging service...
drp.host 127.0.0.1
drp.port 50747
drp.id hawc.pipe.step.crush
drp.fifo 100
drp.timeout 1.0
drp.timestamp

# Whether to flag out data blocks around fluxjumps...
flagjumps

# Do not write PNG thumbnails by default...
forget write.png

# Do not more than one datum in each map pixel...
#forget source.redundancy

# Use the faster maximum-likelihood estimation from the start...
estimator maximum-likelihood

# Manually set a boresight pixel index to override FITS header
#pcenter 15.5,19.5

# The overall rotation of the array from crush x,y coordinates to SI x,y.
rotation 180.2

# The rotation of the T array relative to R.
rotation.R0 0.0
rotation.R1 180.0
rotation.T0 1.0
rotation.T1 181.0

# Subarray offsets (in pixels)
offset.R0 0.0,0.0
offset.R1 67.03,39.0
offset.T0 0.59,-0.55
offset.T1 66.93,39.61



# zoom constants (T vs R)
zoom.T 0.995

# Subarray signal signs
sign.t0 +
sign.r0 +
sign.r1 +

# 1/f stability timescale in seconds
stability 5.0

# The minimum length of a valid scan in seconds.
subscan.minlength 5.0

# Specify the unit of the raw data
dataunit counts

# Specify the output units
unit Jy/beam

# Use long windows initially s.t. there is enough common mode to solve for
# gains
drifts 30.0

# When using non-linear response corrections, make sure the drift window covers
# the entire scan...
[correlated.nonlinearity] drifts max

# The gain conversion to readout units
gain -1.0

# Assumes sign of source signals +, -, or 0
source.sign +

# The appropriate Jy/K conversion value (assuming 2.5m, 95% forward eff.)
#K2Jy 582

# For chopped data, remove the chopper-induced correlated signals...
[chopped] correlated.chopper-x
[chopped] correlated.chopper-y

# Define various shorthands for decorrelations
alias.nonlinearity correlated.nonlinearity
alias.pols correlated.polarrays
alias.subs correlated.subarrays
alias.biaslines correlated.bias
alias.mux correlated.mux
alias.rows correlated.rows

# The range of acceptable relative sky-noise gains.
array.gainRange 0.3:30.0

# Solve for non-linear sky-noise response
nonlinearity

# Decorrelate on polarization arrays
#pols

# Decorrelated on TES bias lines
biaslines
biaslines.gainrange 0.1:10

# Decorrelate on SQUID multiplexed channels
#mux
mux.nogains
mux.gainrange 0.1:10
#iteration.[2] forget mux.nogains

# Decorrelate on detector rows (i.e. MUX address lines)
#rows
rows.gainrange 0.1:10

# Set the observing band based on the SPECTEL1 header value
fits.[SPECTEL1?HAW_A] band A
fits.[SPECTEL1?HAW_B] band B
fits.[SPECTEL1?HAW_C] band C
fits.[SPECTEL1?HAW_D] band D
fits.[SPECTEL1?HAW_E] band E

# Load the appropriate configuration for each band
[band?A] config band-A.cfg
[band?B] config band-B.cfg
[band?C] config band-C.cfg
[band?D] config band-D.cfg
[band?E] config band-E.cfg

# List of FITS keys to add (on top of additional SOFIA keys)
fits.addkeys {&fits.addkeys},INSTCFG

